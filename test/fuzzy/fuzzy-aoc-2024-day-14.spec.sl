import File
import Math
import Gc

Gc.stress(false) // ⚠️ Disable stress mode which is enabled by default for testing - speeds up execution

let robots = File
  .read(cwd() + "/fuzzy-aoc-2024-day-14.txt")
  .split(File.newl)
  .map(fn(l) -> l.ints())

const ROWS = 103
const COLS = 101
const grid = Seq(ROWS).map(fn(y) -> Seq(COLS).map(fn(x) -> 0))
robots.each(fn(r) {
  const [px,py,vx,vy] = r
  grid[py][px]++ // initial position
})

fn move -> robots = robots
  .map(fn(r) {
    const [px,py,vx,vy] = r    
    let nx = (px+vx)%COLS
    let ny = (py+vy)%ROWS
    nx = nx < 0 ? COLS+nx : nx
    ny = ny < 0 ? ROWS+ny : ny

    grid[py][px]-- // leave
    grid[ny][nx]++ // arrive
    ret [nx, ny, vx, vy]
  })

 
let i = 0
for ; i < 100; i++; {
  move()
}

// count quadrants
const left = Math.floor(COLS/2)
const top = Math.floor(ROWS/2)
const qs = [[0,left,0,top],[left+1,COLS,0,top],[0,left,top+1,ROWS],[left+1,COLS,top+1,ROWS]
].map(fn(ranges) {
  const [xf,xt,yf,yt] = ranges
  ret grid[yf..yt].map(fn(row) -> row[xf..xt].sum()).sum()
})

log("Part 1:", qs.fold(1, fn(acc, q) -> acc * q)) // [expect] Part 1: 218295000
while true {
  move()
  i++
  if i == 6870 {
    log("Part 2:", i) // [expect] Part 2: 6870
    log(grid.map(fn(row) -> row.join("")).join("\r\n"))
    break
  }
}

// [expect] 00000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000100
// [expect] 00000000000000000000000000000000000000000000000010000000000010000000000001000000001000000000000000000
// [expect] 00000000000000000000000000000000001000000000000000000000000000000001001000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000
// [expect] 10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00100000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000
// [expect] 00000000000000001000010000000000000000000100000100000000000000000000000000000000000010000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000100000000000000000001000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000000000
// [expect] 00000000000000000000000100000000000000000000000000001000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000100000000010000000000000000000000000000100000001000000000000000
// [expect] 00000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000
// [expect] 00000000000000000000000000000000000000010000000000000000000000000000000001000000000000000000001000010
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000100
// [expect] 00000000000000100000000000000000000000000000000000000000100000000110000000000000000000000000000000000
// [expect] 00000000000000000000000000000100000000000000100000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000010000000000000000000111111111111111111111111111111100010000000000000000000000000001
// [expect] 00000000000000000000000000000000000000100000000000000000000000000000101000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000100000000000000000000000000000100000000000000000000000000000000
// [expect] 00010000000000000000000000000000000000100000000000000000000000000000100000000000000000000000000000100
// [expect] 00000000000000010000000000000000000000100000000000000000000000000000100000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000100000000000000100000000000000100000000000000000000001000000000
// [expect] 00000000000000000000000000000000000000100000000000001110000000000000100000000000000000000000000000000
// [expect] 00001000000000000000000000000000000000100000000000011111000000000000100000000000000000000000000000000
// [expect] 00000010000000000000000000000010000000100000000000111111100000000000100000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000100000000001111111110000000000100000000000000000000000000000000
// [expect] 00000000000000000010000000000000000000100000000000011111000000000000100000000000000000000000000000000
// [expect] 00000000001000000000000000000000000000100000000000111111100000000000100000000000000000000000000001000
// [expect] 00000000000000000000000000000000000000100000000001111111110000000000100000000000000000000000000000000
// [expect] 00000000000000000000000000010000000000100000000011111111111000000000100000000000000000000000000000000
// [expect] 00000000000000000000010000000000000000100000000111111111111100000000100000100000000000000000000000000
// [expect] 00000000000000000000000000000000000010100000000001111111110000000000100000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000100000000011111111111000000000100000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000100000000111111111111100000000100000001000000000000000000000000
// [expect] 00000000100000000000000000000000000000100000001111111111111110000000100000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000100000011111111111111111000000100000000000000000000000000000000
// [expect] 00000000000000000000000000000001000000100000000111111111111100000000100000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000100000001111111111111110000000100000000000100000000000000000000
// [expect] 00000001000000000000000000000000000000100000011111111111111111000000100000000000000010000010000000000
// [expect] 00000000000000000000000000000000000000100000111111111111111111100000100000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000100001111111111111111111110000101000000000000100000000000001000
// [expect] 00000000000000000000000000000000000000100000000000001110000000000000100000000000000000000000000000000
// [expect] 00001000000000000000000000000000000000100000000000001110000000000000101000000000000000000000000000000
// [expect] 00000000000000010000000000000000000000100000000000001110000000000000100000000000000000000000000000000
// [expect] 00000000000000000100000000000000000000100000000000000000000000000000100000000000000000010000000000000
// [expect] 00000000000000000000000000000000000000100000000000000000000000000000100000000000000000000000000000000
// [expect] 00000000000000000100000000000100000000100000000000000000000000000000100000000000000000000000000000000
// [expect] 00000000000000100000000000000000000000100000000000000000000000000000100000000000000000000000000000000
// [expect] 00000000100000000000000000000000000000111111111111111111111111111111100000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00010000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000010
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000
// [expect] 00000000000000000001000000100000000000000000000000000000000000000000000000100000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000
// [expect] 00000000000000000000000000000001000000000000000000000001000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000
// [expect] 00001000000000000000000000100000000000000000000000000000000100000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000100
// [expect] 00000000000000000000000000000000000000000000000001000000000000000000000000000000000000000010000000000
// [expect] 00000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000100
// [expect] 00010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 01000000000000000000000000000100000000000000000000000000000000000000000000000000100000000000000000000
// [expect] 00000000000000000010000000000000000000010000100000000000000000000000000000010000000000000000001000000
// [expect] 00000000000000000000000000000000000000000000100000000000000000000000000000000000000000000010000000000
// [expect] 00000000000001000000010000000000000000000000000000000000000000000000000000000100000000000000000000000
// [expect] 00000000000000000010000000000000000001000000000010000000000000000000001000000000000000000000000000000
// [expect] 00010000010000000000000000000010000000000000000000000000000000000000000000010000000000000000000000000
// [expect] 00000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000010000000000000000000000000000000000000100000000000000000000000000000000000000
// [expect] 00000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000010000000001000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000010000000100000000001000000000000000000000000000
// [expect] 00000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000
// [expect] 10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000100000000000000000000000000000000000000000000000100001000000000000000000000000000000000000000
// [expect] 01000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000
// [expect] 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
